<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clients ‚Äî Client Onboarding</title>
  <link rel="icon" href="/favicon.ico" />
  <script src="./js/i18n.js"></script>
  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--green:#10b981;--red:#ef4444;--gray:#64748b;--border:rgba(148,163,184,.18)}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text)}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    h1{margin:0 0 16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;gap:10px}
    code{color:#cbd5e1}
    .muted{color:var(--muted)}
    
    /* –ö–Ω–æ–ø–∫–∏ */
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    button:hover:not(:disabled) {
      border-color: var(--green);
      background: rgba(16, 185, 129, 0.08);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Input –ø–æ–ª—è */
    input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      width: 100%;
      font-size: 14px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    input:focus {
      border-color: var(--green);
      background: rgba(16, 185, 129, 0.05);
      transform: translateY(-1px);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
      outline: none;
    }
    
    .cols{display:block}
    
    /* Toast */
    #toast{position:fixed;right:16px;bottom:16px;background:rgba(17,24,39,.9);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);pointer-events:none;transition:opacity .2s ease, transform .2s ease;z-index:1000}
    #toast.show{opacity:1;transform:translateY(0)}
    
    /* –†–æ–±–æ—á—ñ —Å—Ç–∏–ª—ñ —Ç–∞–±–ª–∏—Ü—ñ */
    .list {
      display: block;
      margin-top: 12px;
    }
    
    .list table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .list th, .list td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .list th {
      background: rgba(11, 18, 32, 0.8);
      font-weight: 600;
      font-size: 13px;
      color: #cbd5e1;
    }
    
    /* –®–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–æ–∫ */
    .list th:nth-child(1), .list td:nth-child(1) { width: 26%; } /* –Ü–º'—è */
    .list th:nth-child(2), .list td:nth-child(2) { width: 28%; } /* –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç */
    .list th:nth-child(3), .list td:nth-child(3) { width: 7%; text-align: center; } /* ALB */
    .list th:nth-child(4), .list td:nth-child(4) { width: 7%; text-align: center; } /* Cert DNS */
    .list th:nth-child(5), .list td:nth-child(5) { width: 8%; text-align: center; } /* Client DNS */
    .list th:nth-child(6), .list td:nth-child(6) { width: 8%; text-align: center; } /* Web */
    .list th:nth-child(7), .list td:nth-child(7) { width: 16%; text-align: center; } /* –î—ñ—ó */
    
    .list .status-badge {
      background: rgba(148, 163, 184, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: #94a3b8;
    }
    
    .list .btn-deploy {
      background: rgba(6, 182, 212, 0.1);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: #06b6d4;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      margin: 0;
    }
    
    .list .btn-deploy:hover:not(:disabled) {
      background: rgba(6, 182, 212, 0.2);
      border-color: rgba(6, 182, 212, 0.5);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }
    
    .list .btn-applied {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: default;
      margin: 0;
    }
    
    .refresh-web-btn:hover {
      color: #06b6d4 !important;
      transform: rotate(90deg);
      transition: all 0.3s ease;
    }
    
    .list .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .list .dot.green { background: #10b981; }
    .list .dot.gray { background: #64748b; }
    .list .dot.red { background: #ef4444; }
    .list .dot.yellow { background: #fbbf24; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .list .cell-name a { color: #e5e7eb; text-decoration: none; }
    .list .cell-name a:hover { color: #06b6d4; }
    
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω */
    @media (min-width: 1400px) {
      .container { padding: 40px 60px; }
      .card { padding: 24px; }
    }
    
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .card { padding: 12px; }
      .list { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { min-width: 600px; }
    }
    
    /* –ü–µ—Ä–µ–º–∏–∫–∞—á –º–æ–≤ */
    .language-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .language-switcher:hover {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      transform: translateY(-1px);
    }
    
    .flag {
      width: 16px;
      height: 12px;
      border-radius: 2px;
      display: inline-block;
    }
    
    .flag-uk {
      background: linear-gradient(180deg, #005BBB 50%, #FFD500 50%);
    }
    
    .flag-en {
      background: linear-gradient(
        180deg,
        #B22234 0%,
        #B22234 7.7%,
        white 7.7%,
        white 15.4%,
        #B22234 15.4%,
        #B22234 23.1%,
        white 23.1%,
        white 30.8%,
        #B22234 30.8%,
        #B22234 38.5%,
        white 38.5%,
        white 46.2%,
        #B22234 46.2%,
        #B22234 53.9%,
        white 53.9%,
        white 61.6%,
        #B22234 61.6%,
        #B22234 69.3%,
        white 69.3%,
        white 77%,
        #B22234 77%,
        #B22234 84.7%,
        white 84.7%,
        white 92.4%,
        #B22234 92.4%,
        #B22234 100%
      );
      position: relative;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .flag-en:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 40%;
      height: 53.8%;
      background: #3C3B6E;
      background-image: 
        radial-gradient(circle at 15% 20%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 35% 20%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 55% 20%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 75% 20%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 25% 40%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 45% 40%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 65% 40%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 15% 60%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 35% 60%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 55% 60%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 75% 60%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 25% 80%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 45% 80%, white 0.6px, transparent 0.6px),
        radial-gradient(circle at 65% 80%, white 0.6px, transparent 0.6px);
    }
    
    .lang-text {
      color: var(--text);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between">
      <h1 data-i18n="clients.title">–ö–ª—ñ—î–Ω—Ç–∏</h1>
      <div class="row" style="gap: 16px;">
        <div class="language-switcher" onclick="toggleLanguage()">
          <span class="flag flag-uk" id="flag-icon"></span>
          <span class="lang-text" id="current-lang" data-i18n="lang.current">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</span>
        </div>
        <a href="index.html" style="color:var(--muted);text-decoration:none" data-i18n="clients.back-link">‚Üê –ì–æ–ª–æ–≤–Ω–∞</a>
      </div>
    </div>

    <div class="cols">
      <div class="card">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button id="refresh" data-i18n="clients.button.refresh">–û–Ω–æ–≤–∏—Ç–∏</button>
          <button id="refreshK8s" data-i18n="clients.button.refresh-k8s">–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω K8s</button>
          <button id="importNow" data-i18n="clients.button.import">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
          <button id="checkAllDns" data-i18n="clients.button.check-all-dns">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ DNS</button>
          <button id="albStats" data-i18n="clients.button.alb-stats">ALB –≥—Ä—É–ø–∏</button>
          <input id="filter" data-i18n="clients.filter.placeholder" placeholder="–§—ñ–ª—å—Ç—Ä –∑–∞ –¥–æ–º–µ–Ω–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, example.com)" />
        </div>
        <div id="list" class="list">
          <table>
            <colgroup>
              <col style="width:26%">
              <col style="width:28%">
              <col style="width:7%">
              <col style="width:7%">
              <col style="width:8%">
              <col style="width:8%">
              <col style="width:16%">
            </colgroup>
            <thead>
              <tr>
                <th data-i18n="clients.table.name">–Ü–º'—è</th>
                <th data-i18n="clients.table.certificate">–°—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞</th>
                <th data-i18n="clients.table.alb-status" title="–°—Ç–∞—Ç—É—Å ALB –≥—Ä—É–ø–∏">ALB</th>
                <th data-i18n="clients.table.cert-dns-status" title="DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞">Cert DNS</th>
                <th data-i18n="clients.table.client-dns-status" title="DNS –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞ –Ω–∞ ALB">Client DNS</th>
                <th data-i18n="clients.table.web-status">Web</th>
                <th data-i18n="clients.table.actions">–î—ñ—ó</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
              <tr><td colspan="7"><span id="count" class="status-badge"></span></td></tr>
            </tfoot>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const backend = 'https://manage.telegramd.com';
    
    // –ö–µ—à—É–≤–∞–Ω–Ω—è —Ç–∞ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
    let renderTimeout = null;
    let lastRenderData = null;
    let lastRenderTime = 0;
    const RENDER_DEBOUNCE = 100; // –º—Å
    const MIN_RENDER_INTERVAL = 500; // –º—Å
    
    // Debounce —Ñ—É–Ω–∫—Ü—ñ—è
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –¥–∞–Ω–∏—Ö –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑–∞–π–≤–∏—Ö re-render
    function dataChanged(newData, oldData) {
      if (!oldData || newData.length !== oldData.length) return true;
      return JSON.stringify(newData) !== JSON.stringify(oldData);
    }

    // Toast utility
    const showToast = (msg) => {
      let t = document.getElementById('toast');
      if (!t) {
        t = document.createElement('div');
        t.id = 'toast';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.classList.remove('show'), 2500);
    };

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ HTTP —Å—Ç–∞—Ç—É—Å—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
    window.refreshWebStatus = async (clientId) => {
      try {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—ñ
        const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
        if (!row) return;
        
        const webCell = row.querySelector('.web-status-cell');
        if (!webCell) return;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        webCell.innerHTML = '<span class="dot gray" title="Checking..." style="animation: pulse 1.5s ease-in-out infinite;"></span>';
        
        // –í–∏–∫–æ–Ω—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ –Ω–æ–≤–æ–≥–æ endpoint
        const res = await fetch(`${backend}/clients/${clientId}/check-http`, { method: 'POST' });
        if (!res.ok) {
          throw new Error(await res.text());
        }
        
        const data = await res.json();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ª–∞–º–ø–æ—á–∫—É –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        const applied = row.querySelector('.btn-applied') ? true : false;
        webCell.innerHTML = dot(data.status, applied, false, clientId, data.host);
        
        // –ü–æ–∫–∞–∑—É—î–º–æ toast –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        const statusText = data.status === 'up' ? '‚úÖ Online' : data.status === 'down' ? '‚ùå Offline' : '‚ö†Ô∏è Unknown';
        showToast(`${data.host}: ${statusText}`);
      } catch (e) {
        console.error('Failed to refresh web status:', e);
        showToast('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–µ–±-—Å—Ç–∞—Ç—É—Å—É');
      }
    };

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ DNS —Å—Ç–∞—Ç—É—Å—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
    window.refreshDnsStatus = async (clientId) => {
      try {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—ñ
        const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
        if (!row) return;
        
        const dnsCell = row.querySelector('.client-dns-status-cell');
        if (!dnsCell) return;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        dnsCell.innerHTML = '<span class="dot gray" title="Checking DNS..." style="animation: pulse 1.5s ease-in-out infinite;"></span>';
        
        // –í–∏–∫–æ–Ω—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ –Ω–æ–≤–æ–≥–æ endpoint
        const res = await fetch(`${backend}/clients/${clientId}/check-dns`, { method: 'POST' });
        if (!res.ok) {
          throw new Error(await res.text());
        }
        
        const data = await res.json();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ª–∞–º–ø–æ—á–∫—É –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        const applied = row.querySelector('.btn-applied') ? true : false;
        dnsCell.innerHTML = clientDnsStatusDot(
          data.dns_check_status,
          applied,
          false,
          clientId,
          data.host,
          data.dns_check_details
        );
        
        // –ü–æ–∫–∞–∑—É—î–º–æ toast –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        const statusText = 
          data.dns_check_status === 'correct' ? '‚úÖ DNS correct' : 
          data.dns_check_status === 'incorrect' ? '‚ö†Ô∏è DNS incorrect' : 
          data.dns_check_status === 'missing' ? '‚ùå DNS missing' : 
          '‚ö†Ô∏è DNS unknown';
        showToast(`${data.host}: ${statusText}`);
      } catch (e) {
        console.error('Failed to refresh DNS status:', e);
        showToast('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ DNS');
      }
    };

    const dot = (status, applied, loading = false, clientId = null, host = null) => {
      // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ host
      const refreshIcon = (clientId && host) ? `<button onclick="refreshWebStatus(${clientId})" class="refresh-web-btn" title="Check web availability" style="background:none;border:none;cursor:pointer;padding:2px;margin-left:4px;color:#94a3b8;font-size:12px;">üîÑ</button>` : '';
      
      if (loading) return `<span class="dot gray" title="Checking..." style="animation: pulse 1.5s ease-in-out infinite;"></span>${refreshIcon}`;
      if (status === 'up') return `<span class="dot green" title="‚úÖ Online"></span>${refreshIcon}`;
      if (status === 'down') return `<span class="dot red" title="‚ùå Offline"></span>${refreshIcon}`;
      if (!applied) return `<span class="dot gray" title="Not deployed"></span>${refreshIcon}`;
      // –î–ª—è deployed –∫–ª—ñ—î–Ω—Ç—ñ–≤ –±–µ–∑ —Å—Ç–∞—Ç—É—Å—É
      return `<span class="dot gray" title="Click üîÑ to check"></span>${refreshIcon}`;
    };
    
    const albStatusDot = (status, groupName) => {
      const title = `ALB ${groupName || '?'}: ${status}`;
      switch(status) {
        case 'ready': return `<span class="dot green" title="${title} - ALB –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π —ñ –≥–æ—Ç–æ–≤–∏–π"></span>`;
        case 'missing': return `<span class="dot red" title="${title} - ALB –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"></span>`;
        case 'error': return `<span class="dot yellow" title="${title} - –ø–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ ALB"></span>`;
        default: return `<span class="dot gray" title="${title} - –Ω–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å"></span>`;
      }
    };
    
    const dnsStatusDot = (status, certStatus) => {
      const title = `DNS –∑–∞–ø–∏—Å–∏ (${certStatus || 'UNKNOWN'}): ${status}`;
      switch(status) {
        case 'validated': return `<span class="dot green" title="${title} - —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≤–∞–ª—ñ–¥–æ–≤–∞–Ω–∏–π"></span>`;
        case 'ready': return `<span class="dot yellow" title="${title} - DNS –∑–∞–ø–∏—Å–∏ –≥–æ—Ç–æ–≤—ñ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è"></span>`;
        case 'pending': return `<span class="dot gray" title="${title} - –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è DNS –∑–∞–ø–∏—Å—ñ–≤ –≤—ñ–¥ AWS"></span>`;
        case 'failed': return `<span class="dot red" title="${title} - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å"></span>`;
        default: return `<span class="dot gray" title="${title} - –Ω–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å"></span>`;
      }
    };
    
    const clientDnsStatusDot = (status, applied, loading = false, clientId = null, host = null, details = null) => {
      // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ host
      const refreshIcon = (clientId && host) ? `<button onclick="refreshDnsStatus(${clientId})" class="refresh-web-btn" title="Check DNS" style="background:none;border:none;cursor:pointer;padding:2px;margin-left:4px;color:#94a3b8;font-size:12px;">üîç</button>` : '';
      
      if (loading) return `<span class="dot gray" title="Checking DNS..." style="animation: pulse 1.5s ease-in-out infinite;"></span>${refreshIcon}`;
      
      let title = 'Client DNS check';
      if (details && details.error) {
        title = `Error: ${details.error}`;
      } else if (details && details.resolved_to) {
        title = `Resolved to: ${details.resolved_to} (expected: ${details.expected_alb || 'N/A'})`;
      } else if (details && details.resolved_ips && details.resolved_ips.length > 0) {
        title = `Resolved IPs: ${details.resolved_ips.join(', ')}`;
      }
      
      switch(status) {
        case 'correct': return `<span class="dot green" title="${title} - DNS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ"></span>${refreshIcon}`;
        case 'incorrect': return `<span class="dot yellow" title="${title} - DNS –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ"></span>${refreshIcon}`;
        case 'missing': return `<span class="dot red" title="${title} - DNS –∑–∞–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π"></span>${refreshIcon}`;
        case 'error': return `<span class="dot red" title="${title} - –ø–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏"></span>${refreshIcon}`;
        case 'not_checked': return `<span class="dot gray" title="Not checked - click üîç to check"></span>${refreshIcon}`;
        default: return `<span class="dot gray" title="${title}"></span>${refreshIcon}`;
      }
    };

    const fetchHealth = async (domain, params={}) => {
      const sp = new URLSearchParams();
      if (domain) sp.set('domain', domain);
      if (params.include_http === true) sp.set('include_http','true');
      if (params.include_dns === true) sp.set('include_dns','true');
      if (params.check_deployed === true) sp.set('check_deployed','true');
      const qs = sp.toString() ? ('?' + sp.toString()) : '';
      const res = await fetch(backend + '/clients/health' + qs);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    };

    // –ú–µ–º–æ—ñ–∑–∞—Ü—ñ—è –¥–ª—è –ª–∞–º–ø–æ—á–æ–∫ —Ç–∞ –∫–Ω–æ–ø–æ–∫
    const dotCache = new Map();
    const buttonTextCache = new Map();
    
    function getCachedButtonText(applied, canDeploy) {
      const key = `${applied}-${canDeploy}`;
      if (buttonTextCache.has(key)) {
        return buttonTextCache.get(key);
      }
      
      let btnTextKey, btnText, btnClass, disabled;
      if (applied) {
        // –í–∂–µ –∑–∞–¥–µ–ø–ª–æ—î–Ω–æ - –ø–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç—É—Å, –Ω–µ –∫–Ω–æ–ø–∫—É
        btnTextKey = 'clients.button.applied';
        btnText = window.i18n ? window.i18n.t(btnTextKey) : '–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ';
        btnClass = 'btn-applied';
        disabled = true;
      } else if (canDeploy) {
        // –ì–æ—Ç–æ–≤–∏–π –¥–æ –¥–µ–ø–ª–æ—é
        btnTextKey = 'clients.button.deploy-ingress';
        btnText = window.i18n ? window.i18n.t(btnTextKey) : '–î–µ–ø–ª–æ–π —ñ–Ω–≥—Ä–µ—Å';
        btnClass = 'btn-deploy';
        disabled = false;
      } else {
        // –ù–µ –≥–æ—Ç–æ–≤–∏–π
        btnTextKey = 'clients.button.unavailable';
        btnText = window.i18n ? window.i18n.t(btnTextKey) : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
        btnClass = 'btn-deploy';
        disabled = true;
      }
      
      const result = { btnTextKey, btnText, btnClass, disabled };
      buttonTextCache.set(key, result);
      return result;
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–∫—Ä–µ–º–æ–≥–æ —Ä—è–¥–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—ñ
    const updateSingleRow = (clientData) => {
      const row = document.querySelector(`tr[data-client-id="${clientData.id}"]`);
      if (!row) return;
      
      const webCell = row.querySelector('.web-status-cell');
      if (webCell) {
        webCell.innerHTML = dot(clientData.status, clientData.applied, false, clientData.id, clientData.host);
      }
    };
    
    const updateTable = (rowsData) => {
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–º—ñ–Ω–∏
      if (!dataChanged(rowsData, lastRenderData)) {
        return; // –ù—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—è
      }
      
      const now = Date.now();
      if (now - lastRenderTime < MIN_RENDER_INTERVAL) {
        // –ó–∞–Ω–∞–¥—Ç–æ —á–∞—Å—Ç–æ, –æ—á—ñ–∫—É—î–º–æ
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => updateTable(rowsData), MIN_RENDER_INTERVAL - (now - lastRenderTime));
        return;
      }
      
      lastRenderData = rowsData;
      lastRenderTime = now;
      
      let html = '';
      try {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ document fragment –¥–ª—è –∫—Ä–∞—â–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
        html = rowsData.map(c => {
          const nameContent = c.host ? 
            `<a href="https://${c.host}" target="_blank" rel="noopener noreferrer">${c.host}</a>` : 
            '<span class="muted">–Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</span>';
          
          const certStatus = (c.cert_status || '-') + (c.group_name ? (' ¬∑ ' + c.group_name) : '');
          
          // Web —Å—Ç–∞—Ç—É—Å –∑ –∫–Ω–æ–ø–∫–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑ host
          const webStatus = dot(c.status, c.applied, false, c.id, c.host);
          
          // Client DNS —Å—Ç–∞—Ç—É—Å –∑ –∫–Ω–æ–ø–∫–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–ª—è deployed –∫–ª—ñ—î–Ω—Ç—ñ–≤
          const clientDnsStatus = clientDnsStatusDot(
            c.dns_check_status || 'not_checked',
            c.applied,
            false,
            c.id,
            c.host,
            c.dns_check_details
          );
          
          const { btnTextKey, btnText, btnClass, disabled } = getCachedButtonText(c.applied, !!c.can_deploy);
          
          return `<tr data-client-id="${c.id}">
            <td class="cell-name">${nameContent}</td>
            <td><span class="status-badge">${certStatus}</span></td>
            <td>${albStatusDot(c.alb_status, c.group_name)}</td>
            <td>${dnsStatusDot(c.dns_records_status, c.cert_status)}</td>
            <td class="client-dns-status-cell">${clientDnsStatus}</td>
            <td class="web-status-cell">${webStatus}</td>
            <td><button data-id="${c.id}" data-path="${c.ingress_path||''}" data-i18n-key="${btnTextKey}" class="${btnClass}" ${disabled?'disabled':''}>${btnText}</button></td>
          </tr>`;
        }).join('');
      } catch (e) {
        console.error('Render error:', e);
        html = '';
      }
      
      // –û–¥–∏–Ω DOM update
      const tbody = document.getElementById('tbody');
      const countEl = document.getElementById('count');
      
      if (html && html.length > 0) {
        tbody.innerHTML = html;
        countEl.textContent = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${rowsData.length}`;
      } else {
        tbody.innerHTML = '<tr><td colspan="7" style="color:#94a3b8">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr>';
        countEl.textContent = '–ü–æ—Ä–æ–∂–Ω—å–æ';
      }
      
      // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—ñ–≤ –±–µ–∑ setTimeout
      updateLocalizedContent();
    };

    // –ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∞ HTTP –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É)
    const probeClientHttp = async (clientData) => {
      if (!clientData.applied || !clientData.host) return clientData;
      
      try {
        const res = await fetch(`${backend}/clients/health?include_http=true&check_deployed=true`);
        if (!res.ok) return clientData;
        
        const allData = await res.json();
        const updated = allData.find(c => c.id === clientData.id);
        
        if (updated) {
          return updated;
        }
      } catch (e) {
        console.debug('HTTP probe failed for client', clientData.id, e);
      }
      
      return clientData;
    };
    
    // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ render —Ñ—É–Ω–∫—Ü—ñ—è
    let isRendering = false;
    let pendingRender = false;
    
    const render = async (forceRefresh = false, includeHttp = false, includeDns = false) => {
      if (isRendering && !forceRefresh) {
        pendingRender = true;
        return;
      }
      
      isRendering = true;
      pendingRender = false;
      
      try {
        const domain = document.getElementById('filter').value.trim();
        
        // –ö–†–û–ö 1: –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±–∞–∑–æ–≤—ñ –¥–∞–Ω—ñ –ë–ï–ó HTTP/DNS –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        console.log('Loading basic client data...');
        const basicData = await fetchHealth(domain || undefined, {});
        
        if (!basicData || basicData.length === 0) {
          console.warn('No clients data received');
          const tbody = document.getElementById('tbody');
          const count = document.getElementById('count');
          if (tbody && count) {
            tbody.innerHTML = '<tr><td colspan="7" style="color:#94a3b8">–ü–æ—Ä–æ–∂–Ω—å–æ</td></tr>';
            count.textContent = '–ü–æ—Ä–æ–∂–Ω—å–æ';
          }
          return;
        }
        
        // –°–æ—Ä—Ç—É—î–º–æ —ñ –ø–æ–∫–∞–∑—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é –û–î–†–ê–ó–£
        basicData.sort((a,b)=> (a.host||'').localeCompare(b.host||''));
        console.log('Loaded clients:', basicData.length);
        updateTable(basicData);
        
        // –ö–†–û–ö 2: –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ HTTP —Å—Ç–∞—Ç—É—Å–∏ (—Ñ–æ–Ω–æ–≤–æ)
        if (includeHttp) {
          console.log('Loading HTTP statuses in background...');
          setTimeout(async () => {
            try {
              const params = { include_http: true };
              const httpData = await fetchHealth(domain || undefined, params);
              if (httpData && httpData.length > 0) {
                httpData.sort((a,b)=> (a.host||'').localeCompare(b.host||''));
                updateTable(httpData);
                console.log('HTTP statuses updated');
              }
            } catch (e) {
              console.error('Failed to load HTTP statuses:', e);
            }
          }, 100);
        }
        
        // –ö–†–û–ö 3: –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ DNS —Å—Ç–∞—Ç—É—Å–∏ (—Ñ–æ–Ω–æ–≤–æ)
        if (includeDns) {
          console.log('Loading DNS statuses in background...');
          setTimeout(async () => {
            try {
              const params = { include_dns: true };
              const dnsData = await fetchHealth(domain || undefined, params);
              if (dnsData && dnsData.length > 0) {
                dnsData.sort((a,b)=> (a.host||'').localeCompare(b.host||''));
                updateTable(dnsData);
                console.log('DNS statuses updated');
              }
            } catch (e) {
              console.error('Failed to load DNS statuses:', e);
            }
          }, 200);
        }
        
      } catch (err) {
        console.error('Render error:', err);
        // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏
        const tbody = document.getElementById('tbody');
        const count = document.getElementById('count');
        if (tbody && count) {
          tbody.innerHTML = `<tr><td colspan="7" style="color:#ef4444">–ü–æ–º–∏–ª–∫–∞: ${String(err).substring(0, 100).replace(/</g,'&lt;')}</td></tr>`;
          count.textContent = '–ü–æ–º–∏–ª–∫–∞';
        }
      } finally {
        isRendering = false;
        
        // –Ø–∫—â–æ –±—É–≤ –∑–∞–ø–∏—Ç –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        if (pendingRender) {
          setTimeout(render, 100);
        }
      }
    };

    // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ event listeners
    const debouncedRender = debounce(() => render(false, true), RENDER_DEBOUNCE);
    const debouncedSearch = debounce(() => render(true, true), 300); // 300–º—Å –¥–ª—è –ø–æ—à—É–∫—É
    
    document.getElementById('refresh').addEventListener('click', () => render(true, true));
    document.getElementById('filter').addEventListener('input', debouncedSearch); // input –∑–∞–º—ñ—Å—Ç—å change
    document.getElementById('filter').addEventListener('change', debouncedSearch);

    document.getElementById('refreshK8s').addEventListener('click', async () => {
      const btn = document.getElementById('refreshK8s');
      try {
        btn.disabled = true; btn.textContent = 'K8s...';
        const res = await fetch(backend + '/k8s/snapshot/refresh', { method:'POST' });
        if (!res.ok) throw new Error(await res.text());
        showToast('K8s –æ–Ω–æ–≤–ª–µ–Ω–æ');
        await render(false, true);
      } catch (err) {
        alert(String(err));
      } finally {
        btn.disabled = false; btn.textContent = '–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω K8s';
      }
    });

    document.getElementById('importNow').addEventListener('click', async () => {
      try {
        const domain = document.getElementById('filter').value.trim();
        const q = domain ? ('?domain=' + encodeURIComponent(domain)) : '';
        const btn = document.getElementById('importNow');
        btn.disabled = true; btn.textContent = '–Ü–º–ø–æ—Ä—Ç...';
        const res = await fetch(backend + '/clients/import' + q, { method:'POST' });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        showToast(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${data.count}`);
        await render(false, true);
      } catch (err) {
        alert(String(err));
      } finally {
        const btn = document.getElementById('importNow');
        btn.disabled = false; btn.textContent = '–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏';
      }
    });

    document.getElementById('checkAllDns').addEventListener('click', async () => {
      const btn = document.getElementById('checkAllDns');
      const originalText = btn.textContent;
      try {
        btn.disabled = true;
        btn.textContent = window.i18n ? window.i18n.t('clients.loading') : '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';
        
        const domain = document.getElementById('filter').value.trim();
        const params = new URLSearchParams({ include_dns: 'true' });
        if (domain) params.set('domain', domain);
        
        const res = await fetch(`${backend}/clients/health?${params.toString()}`);
        if (!res.ok) throw new Error(await res.text());
        
        const data = await res.json();
        const checkedCount = data.filter(c => c.dns_check_status && c.dns_check_status !== 'not_checked').length;
        
        showToast(`–ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ DNS –¥–ª—è ${checkedCount} –∫–ª—ñ—î–Ω—Ç—ñ–≤`);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)
        await render();
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ DNS: ' + err);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    document.getElementById('albStats').addEventListener('click', async () => {
      const btn = document.getElementById('albStats');
      try {
        btn.disabled = true; 
        btn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        
        const res = await fetch(backend + '/alb/group-recommendations');
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é
        showAlbStats(data);
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ALB —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ALB –≥—Ä—É–ø–∏';
      }
    });

    document.addEventListener('click', async (e) => {
      const t = e.target;
      // –¢—ñ–ª—å–∫–∏ –∫–Ω–æ–ø–∫–∏ Deploy (–Ω–µ Applied)
      if (t && t.classList && t.classList.contains('btn-deploy') && !t.classList.contains('btn-applied') && !t.disabled) {
        const id = t.getAttribute('data-id');
        if (!id) return;
        
        const originalText = t.textContent;
        
        try {
          t.disabled = true; 
          t.textContent = window.i18n ? window.i18n.t('clients.loading') : '–î–µ–ø–ª–æ–π...';
          
          const res = await fetch(backend + `/clients/${id}/deploy`, { method:'POST' });
          if (!res.ok) throw new Error(await res.text());
          
          const data = await res.json().catch(()=>({}));
          const successMsg = window.i18n?.getCurrentLanguage() === 'en' 
            ? `Applied ${data.host||''} (${data.namespace||'prod'})`
            : `–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ ${data.host||''} (${data.namespace||'prod'})`;
          
          showToast(successMsg);
          await render(false, true);
        } catch (err) {
          alert(String(err));
          t.disabled = false;
          t.textContent = originalText;
        }
      }
    });


    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ HTTP –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
    let autoRefreshInterval = null;
    let refreshIntervalTime = 1800000; // —ñ–Ω—Ç–µ—Ä–≤–∞–ª 30 —Ö–≤–∏–ª–∏–Ω (HTTP –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, –±–µ–∑ K8s)
    
    function startAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      autoRefreshInterval = setInterval(() => {
        // –ù–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏, —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
        if (document.hidden) return;
        render(false, true); // Auto-refresh –∑ HTTP –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
      }, refreshIntervalTime);
    }
    
    // –ü—Ä–∏–∑—É–ø–∏–Ω—è—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –∫–æ–ª–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –≤–∏–¥–Ω–∞
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      } else {
        // –û–Ω–æ–≤–∏—Ç–∏ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
        render(true, true);
        startAutoRefresh();
      }
    });
    
    // –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É ALB —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function showAlbStats(data) {
      const modalId = 'albStatsModal';
      
      // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –º–æ–¥–∞–ª
      const existing = document.getElementById(modalId);
      if (existing) existing.remove();
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ HTML —Ç–∞–±–ª–∏—Ü—ñ –≥—Ä—É–ø
      const groupsTable = data.group_statistics.map(group => {
        const statusColor = group.status === 'available' ? '#10b981' : '#ef4444';
        const statusText = group.status === 'available' ? '–î–æ—Å—Ç—É–ø–Ω–æ' : '–ü–æ–≤–Ω–∞';
        const configBadge = group.configured ? 
          '<span style="background:#10b981;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:4px">–ö–æ–Ω—Ñ—ñ–≥—É—Ä–æ–≤–∞–Ω–æ</span>' :
          '<span style="background:#94a3b8;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:4px">Auto</span>';
        
        return `
          <tr>
            <td style="font-weight:500">${group.group_name}${configBadge}</td>
            <td>${group.certificate_count}/${group.max_certificates}</td>
            <td style="color:${statusColor};font-weight:500">${statusText}</td>
            <td style="font-size:11px;color:#64748b;max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${group.dns_hostname || '–ù–µ–º–∞—î'}">${group.dns_hostname || '–ù–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ'}</td>
          </tr>
        `;
      }).join('');
      
      const modal = document.createElement('div');
      modal.id = modalId;
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      `;
      
      modal.innerHTML = `
        <div style="
          background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
          border: 1px solid rgba(148,163,184,0.2);
          border-radius: 16px;
          padding: 24px;
          max-width: 800px;
          width: 90%;
          color: #e5e7eb;
          backdrop-filter: blur(10px);
        ">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0;font-size:20px">üìä ALB –ì—Ä—É–ø–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <button onclick="document.getElementById('${modalId}').remove()" style="
              background: none;
              border: none;
              color: #94a3b8;
              font-size: 24px;
              cursor: pointer;
              padding: 0;
              width: 30px;
              height: 30px;
            ">&times;</button>
          </div>
          
          <div style="margin-bottom:16px;padding:12px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:8px">
            <strong>üéØ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –≥—Ä—É–ø–∞:</strong> <code>${data.recommended_group}</code><br>
            <small style="color:#94a3b8">–ù–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –≤ —Ü—é –≥—Ä—É–ø—É</small>
          </div>
          
          <table style="width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,0.02);border-radius:8px;overflow:hidden">
            <thead>
              <tr style="background:rgba(11,18,32,0.8)">
                <th style="padding:12px;text-align:left;font-size:12px;color:#cbd5e1">–ù–∞–∑–≤–∞ –ì—Ä—É–ø–∏</th>
                <th style="padding:12px;text-align:left;font-size:12px;color:#cbd5e1">–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</th>
                <th style="padding:12px;text-align:left;font-size:12px;color:#cbd5e1">–°—Ç–∞—Ç—É—Å</th>
                <th style="padding:12px;text-align:left;font-size:12px;color:#cbd5e1">DNS Hostname</th>
              </tr>
            </thead>
            <tbody>
              ${groupsTable}
            </tbody>
          </table>
          
          <div style="margin-top:16px;padding:12px;background:rgba(148,163,184,0.1);border-radius:8px;font-size:12px;color:#94a3b8">
            üìà –õ—ñ–º—ñ—Ç: <strong>${data.certificate_limit_per_group}</strong> —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞ –≥—Ä—É–ø—É |
            üìã –ö–æ–Ω—Ñ—ñ–≥—É—Ä–æ–≤–∞–Ω–æ: <strong>${data.total_configured_groups}</strong> –≥—Ä—É–ø(–∏) |
            ‚öôÔ∏è –°—Ç—Ä–∞—Ç–µ–≥—ñ—è: <strong>${data.alb_creation_strategy}</strong>
          </div>
          
          ${data.new_alb_required ? `
            <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;font-size:13px;color:#fbbf24">
              ‚ö†Ô∏è <strong>–ü–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–≤–∏–π ALB!</strong><br>
              –ì—Ä—É–ø–∞: <code>${data.alb_creation_info.group_name}</code><br>
              <small style="color:#94a3b8">${data.alb_creation_info.message}</small>
              <br><button onclick="showAlbCreationInstructions('${data.alb_creation_info.group_name}')" style="
                margin-top:8px;
                padding:4px 8px;
                background:rgba(251,191,36,0.1);
                border:1px solid rgba(251,191,36,0.3);
                color:#fbbf24;
                border-radius:4px;
                cursor:pointer;
                font-size:11px;
              ">–ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó</button>
            </div>
          ` : ''}
          
          <div style="margin-top:16px;text-align:center">
            <button onclick="document.getElementById('${modalId}').remove()" style="
              padding: 8px 16px;
              background: rgba(16,185,129,0.1);
              border: 1px solid rgba(16,185,129,0.3);
              color: #10b981;
              border-radius: 6px;
              cursor: pointer;
            ">–ó–∞–∫—Ä–∏—Ç–∏</button>
          </div>
        </div>
      `;
      
      // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ALB
    async function showAlbCreationInstructions(groupName) {
      try {
        const res = await fetch(`${backend}/alb/creation-instructions/${groupName}`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        
        const modalId = 'albInstructionsModal';
        const existing = document.getElementById(modalId);
        if (existing) existing.remove();
        
        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–Ω—Ç–µ–Ω—Ç—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó
        let instructionsContent = '';
        
        if (data.alb_exists) {
          instructionsContent = `
            <div style="padding:16px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.2);border-radius:8px;color:#10b981">
              ‚úÖ <strong>ALB –≤–∂–µ —ñ—Å–Ω—É—î!</strong><br>
              –ì—Ä—É–ø–∞: <code>${groupName}</code><br>
              DNS: <code>${data.dns_hostname}</code>
            </div>
          `;
        } else {
          const instructions = data.instructions;
          
          if (instructions.strategy === 'k8s-controller') {
            instructionsContent = `
              <div style="padding:16px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:8px;color:#3b82f6">
                ü§ñ <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</strong><br>
                <p>–ì—Ä—É–ø–∞: <code>${groupName}</code></p>
                <p>${instructions.message}</p>
                <div style="background:rgba(59,130,246,0.05);padding:12px;border-radius:6px;margin:8px 0;font-size:12px">
                  <strong>–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:</strong><br>
                  ${instructions.next_steps}
                </div>
              </div>
            `;
          } else if (instructions.strategy === 'manual') {
            const steps = instructions.aws_console_instructions.steps.map(step => 
              `<li style="margin:4px 0;font-size:13px">${step}</li>`
            ).join('');
            
            instructionsContent = `
              <div style="padding:16px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);border-radius:8px;color:#fbbf24">
                ‚öôÔ∏è <strong>–ú–∞–Ω—É–∞–ª—å–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</strong><br>
                <p>–ì—Ä—É–ø–∞: <code>${groupName}</code></p>
                
                <div style="margin:16px 0">
                  <h4 style="margin:8px 0;color:#fbbf24">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó AWS Console:</h4>
                  <ol style="margin:0;padding-left:20px;">${steps}</ol>
                </div>
                
                <details style="margin:16px 0;">
                  <summary style="cursor:pointer;color:#fbbf24;font-weight:bold">üìÑ Terraform –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è</summary>
                  <pre style="background:rgba(0,0,0,0.2);padding:12px;border-radius:6px;overflow:auto;font-size:11px;margin:8px 0;white-space:pre-wrap">${instructions.terraform_config}</pre>
                </details>
              </div>
            `;
          } else {
            instructionsContent = `
              <div style="padding:16px;background:rgba(148,163,184,0.1);border:1px solid rgba(148,163,184,0.2);border-radius:8px;color:#64748b">
                üìù <strong>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</strong><br>
                <p>${instructions.message}</p>
                <p><strong>–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:</strong> ${instructions.next_steps}</p>
              </div>
            `;
          }
        }
        
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          backdrop-filter: blur(5px);
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 16px;
            padding: 24px;
            max-width: 800px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            color: #e5e7eb;
            backdrop-filter: blur(10px);
          ">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
              <h3 style="margin:0;font-size:18px">üîß ALB –°—Ç–≤–æ—Ä–µ–Ω–Ω—è - ${groupName}</h3>
              <button onclick="document.getElementById('${modalId}').remove()" style="
                background: none;
                border: none;
                color: #94a3b8;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
              ">&times;</button>
            </div>
            
            ${instructionsContent}
            
            <div style="margin-top:20px;text-align:center">
              <button onclick="document.getElementById('${modalId}').remove()" style="
                padding: 8px 16px;
                background: rgba(16,185,129,0.1);
                border: 1px solid rgba(16,185,129,0.3);
                color: #10b981;
                border-radius: 6px;
                cursor: pointer;
              ">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
          </div>
        `;
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
        
        document.body.appendChild(modal);
        
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π: ' + err);
      }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∫–ª–∏–∫—É –∑ HTML
    window.showAlbCreationInstructions = showAlbCreationInstructions;
    
    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ HTTP –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
    render(false, true);
    startAutoRefresh();
    
    // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó
    function updateLanguageFlag() {
      const flagIcon = document.getElementById('flag-icon');
      if (flagIcon && window.i18n) {
        const lang = window.i18n.getCurrentLanguage();
        flagIcon.className = `flag flag-${lang}`;
      }
    }
    
    window.toggleLanguage = function() {
      if (window.i18n) {
        window.i18n.toggleLanguage();
        updateLanguageFlag();
        // –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
        updateLocalizedContent();
      }
    };
    
    // –ö–µ—à DOM –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
    let cachedElements = null;
    
    function getCachedElements() {
      if (!cachedElements) {
        cachedElements = {
          refreshBtn: document.getElementById('refresh'),
          refreshK8sBtn: document.getElementById('refreshK8s'),
          importBtn: document.getElementById('importNow'),
          checkAllDnsBtn: document.getElementById('checkAllDns'),
          albStatsBtn: document.getElementById('albStats'),
          count: document.getElementById('count')
        };
      }
      return cachedElements;
    }
    
    function updateLocalizedContent() {
      if (!window.i18n) return; // –ù—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ i18n –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
      
      const elements = getCachedElements();
      
      // –û–Ω–æ–≤–∏—Ç–∏ –º—ñ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–µ disabled)
      if (elements.refreshBtn && !elements.refreshBtn.disabled) {
        elements.refreshBtn.textContent = window.i18n.t('clients.button.refresh');
      }
      
      if (elements.refreshK8sBtn && !elements.refreshK8sBtn.disabled) {
        elements.refreshK8sBtn.textContent = window.i18n.t('clients.button.refresh-k8s');
      }
      
      if (elements.importBtn && !elements.importBtn.disabled) {
        elements.importBtn.textContent = window.i18n.t('clients.button.import');
      }
      
      if (elements.checkAllDnsBtn && !elements.checkAllDnsBtn.disabled) {
        elements.checkAllDnsBtn.textContent = window.i18n.t('clients.button.check-all-dns');
      }
      
      if (elements.albStatsBtn && !elements.albStatsBtn.disabled) {
        elements.albStatsBtn.textContent = window.i18n.t('clients.button.alb-stats');
      }
      
      // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—ñ
      try {
        const actionButtons = document.querySelectorAll('.btn-deploy[data-i18n-key]:not(:disabled)');
        for (const btn of actionButtons) {
          const key = btn.getAttribute('data-i18n-key');
          if (key) {
            btn.textContent = window.i18n.t(key);
          }
        }
      } catch (e) {
        console.debug('Button translation update failed:', e);
      }
      
      // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫
      if (elements.count && elements.count.textContent) {
        const match = elements.count.textContent.match(/\d+/);
        if (match) {
          const num = match[0];
          const currentLang = window.i18n.getCurrentLanguage();
          const prefix = currentLang === 'en' ? 'Loaded' : '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ';
          elements.count.textContent = `${prefix} ${num}`;
        }
      }
      
      // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à –∫–Ω–æ–ø–æ–∫ –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –º–æ–≤–∏
      buttonTextCache.clear();
    }
    
    // –û–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ñ–ª–∞–≥ –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó
    setTimeout(() => {
      updateLanguageFlag();
      updateLocalizedContent();
    }, 100);
  </script>
</body>
</html>